From 066781a03382b4758687ff34dcc2b303411f5bcd Mon Sep 17 00:00:00 2001
From: Jason Chiu <general@jasonchiu.slmail.me>
Date: Sat, 10 Jan 2026 10:08:39 -0800
Subject: [PATCH 1/2] hyprpm: read /etc/portage/make.conf and pass env vars to
 plugin builds

Add RE2 dependency to hyprpm and modify execAndGet to accept environment
variables. When building plugins, read /etc/portage/make.conf (if it exists)
and pass the environment variables to the build commands.

This is useful for Gentoo users who have custom CFLAGS/CXXFLAGS/etc in
their make.conf.
---
 hyprpm/CMakeLists.txt             |  2 +-
 hyprpm/src/core/PluginManager.cpp | 32 +++++++++++++++++++++++++++++--
 2 files changed, 31 insertions(+), 3 deletions(-)

diff --git a/hyprpm/CMakeLists.txt b/hyprpm/CMakeLists.txt
index ee73810..dfcf534 100644
--- a/hyprpm/CMakeLists.txt
+++ b/hyprpm/CMakeLists.txt
@@ -9,7 +9,7 @@ file(GLOB_RECURSE SRCFILES CONFIGURE_DEPENDS "src/*.cpp")
 
 set(CMAKE_CXX_STANDARD 23)
 
-pkg_check_modules(hyprpm_deps REQUIRED IMPORTED_TARGET tomlplusplus hyprutils>=0.7.0)
+pkg_check_modules(hyprpm_deps REQUIRED IMPORTED_TARGET re2 tomlplusplus hyprutils>=0.7.0)
 
 find_package(glaze 6.0.0 QUIET)
 if (NOT glaze_FOUND)
diff --git a/hyprpm/src/core/PluginManager.cpp b/hyprpm/src/core/PluginManager.cpp
index 0d35b4a..9a521fc 100644
--- a/hyprpm/src/core/PluginManager.cpp
+++ b/hyprpm/src/core/PluginManager.cpp
@@ -16,12 +16,15 @@
 #include <fstream>
 #include <algorithm>
 #include <format>
+#include <unordered_map>
+#include <type_traits>
 
 #include <sys/types.h>
 #include <sys/stat.h>
 #include <pwd.h>
 #include <unistd.h>
 
+#include <re2/re2.h>
 #include <toml++/toml.hpp>
 #include <glaze/glaze.hpp>
 
@@ -32,16 +35,23 @@ using namespace Hyprutils::String;
 using namespace Hyprutils::OS;
 using namespace Hyprutils::Memory;
 
-static std::string execAndGet(std::string cmd) {
+template<typename C, typename = std::enable_if_t<
+    std::is_same_v<typename C::value_type, std::pair<const std::string, std::string>>>
+> static std::string execAndGet(std::string cmd, C const &env_vars) {
     cmd += " 2>&1";
 
     CProcess proc("/bin/sh", {"-c", cmd});
+    for (const auto &[k, v] : env_vars)
+        proc.addEnv(k, v);
 
     if (!proc.runSync())
         return "error";
 
     return proc.stdOut();
 }
+static inline std::string execAndGet(std::string cmd) {
+    return execAndGet(cmd, std::vector<std::pair<const std::string, std::string> >());
+}
 
 static std::string getTempRoot() {
     static auto ENV = getenv("XDG_RUNTIME_DIR");
@@ -288,6 +298,24 @@ bool CPluginManager::addNewPluginRepo(const std::string& url, const std::string&
 
     progress.m_iSteps = 3;
     progress.printMessageAbove(successString("Hyprland headers OK"));
+
+    static const std::filesystem::path env_file("/etc/portage/make.conf");
+    std::unordered_map<std::string, std::string> vars;
+    if (std::filesystem::is_regular_file(env_file)) {
+        progress.printMessageAbove(infoString("Reading {}", env_file.string()));
+        CProcess proc("/bin/bash", {"-exc", "cd \"$1\"; . \"$2\"", "bash", env_file.parent_path().string(), env_file.filename().string()});
+        if (!proc.runSync()) {
+            std::println(stderr, "\n{}", failureString("Couldn't read {}", env_file.string()));
+            return false;
+        }
+        re2::StringPiece input(proc.stdErr());
+        std::string name, quoted_value, value;
+        const RE2 re(R"((?m)^(?:\++ )?((?i:[a-z_]\w*))=(?:'((?s:.*?))'|((?:[!-&(-~].*)?))$)");
+        while (RE2::FindAndConsume(&input, re, &name, &quoted_value, &value))
+            if (!getenv(name.c_str()))
+                vars[name] = quoted_value.empty() ? value : quoted_value;
+    }
+
     progress.m_szCurrentMessage = "Building plugin(s)";
     progress.print();
 
@@ -304,7 +332,7 @@ bool CPluginManager::addNewPluginRepo(const std::string& url, const std::string&
 
         for (auto const& bs : p.buildSteps) {
             const std::string& cmd = std::format("cd {} && PKG_CONFIG_PATH=\"{}/share/pkgconfig\" {}", m_szWorkingPluginDirectory, DataState::getHeadersPath(), bs);
-            out += " -> " + cmd + "\n" + execAndGet(cmd) + "\n";
+            out += " -> " + cmd + "\n" + execAndGet(cmd, vars) + "\n";
         }
 
         if (m_bVerbose)
-- 
2.52.0

